stages:
  - build dependency
  - build conveyor
  - test

# AUTORUN
build dependency image:
  stage: build dependency
  tags:
    - 1c-server
  rules:
    - changes:
      - dependency-image/Dockerfile
      - dependency-image/docker-compose.yml
  script:
    - cd dependency-image && docker-compose up --build --remove-orphans
build conveyor image:
  stage: build conveyor
  tags:
    - 1c-server
  rules:
    - changes:
      - conveyor-image/*
  script:
    - cd conveyor-image && docker-compose --env-file ./config.env up --build --remove-orphans
build test image:
  stage: test
  tags:
    - 1c-server
  rules:
    - changes:
      - generator/test-dockerfile/*
  script:
    - cd generator/test-dockerfile && docker-compose up --build --remove-orphans
# MANUAL RUN
build dependency image (manual):
  stage: build dependency
  tags:
    - 1c-server
  rules:
    - changes:
      - .gitlab-ci.yml
      when: manual
      allow_failure: true
  script:
    - cd dependency-image && docker-compose up --build --remove-orphans
build conveyor image (manual):
  stage: build conveyor
  tags:
    - 1c-server
  rules:
    - changes:
      - .gitlab-ci.yml
      when: manual
      allow_failure: true
  script:
    - cd conveyor-image && docker-compose --env-file ./config.env up --build --remove-orphans
build test image (manual):
  stage: test
  tags:
    - 1c-server
  rules:
    - changes:
      - .gitlab-ci.yml
      when: manual
      allow_failure: true
  script:
    - cd generator/test-dockerfile && docker-compose up --build --remove-orphans